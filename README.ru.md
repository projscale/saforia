# Saforia

Детерминированный генератор паролей: пароли для разных сервисов получаются из одного мастер‑пароля. Мастер‑пароль хранится только в зашифрованном виде, ключом для шифрования служит отдельный viewer‑пароль. Его можно вводить публично — он не раскрывает мастер‑пароль.

Статус: ранний прототип. Кроссплатформенное приложение (Tauri 2): Rust‑бэкенд и React + Vite фронтенд.

## Основные идеи
- Единственный мастер‑пароль (никогда не хранится в открытом виде). На диске шифруется Argon2id + ChaCha20‑Poly1305 под viewer‑пароль. В веб‑/mock‑режиме разработки мастер также шифруется viewer‑паролем: AES‑GCM (если доступен WebCrypto на защищённом источнике, localhost/https) или дев‑фолбэк (потоковый XOR‑шифр с тегом целостности) на небезопасных источниках (например, host.docker.internal).
- Для каждого сервиса сохраняется постфикс (suffix). Для каждого постфикса выбирается метод генерации.
- Генерация детерминирована: хэш(master + postfix) → символы заданного алфавита.
- Обратная совместимость: поддержаны два исторических формата (v1 MD5+B64, v2 SHA256+URL‑B64).
- Новые методы: длины 10/20/36 символов, варианты только буквы+цифры и «с символами». По умолчанию — 36 с символами.
- Безопасность: скрытое отображение, копирование только по кнопке, авто‑очистка, best‑effort защита от снятия скриншотов (Windows/Mac).
  - Android: включается FLAG_SECURE для запрета скриншотов/записи.
  - Опция авто‑очистки буфера обмена: по таймеру очищает clipboard после копирования.
  - iOS: обнаружение записи экрана — при активном захвате контент скрывается оверлеем, действия просмотра/копирования блокируются.

## Использование
- При первом запуске задайте мастер‑пароль и viewer‑пароль. Мастер‑пароль на диске шифруется viewer‑паролем.
- Единый экран:
  - Сверху: поиск — мгновенная фильтрация сохранённых записей.
  - По центру: прокручиваемый список сохранённых (лейбл • бейдж метода • postfix). Кнопка Generate откроет запрос viewer‑пароля и скопирует результат.
  - Снизу: «консоль» — введите postfix, выберите метод и нажмите Generate (запрос viewer). Включите «Сохранить этот постфикс», чтобы записать в базу сразу.
 - «Настройки»: задайте метод генерации по умолчанию для быстрой генерации и новых записей.
 - «Настройки»: «Автосохранение в Быстрой генерации» включает галочку «Сохранить этот постфикс» по умолчанию.
 - «Настройки»: на Linux/Wayland включите «Скрывать чувствительные данные», если на вашей системе нельзя надёжно блокировать захват экрана.
 - «Резервная копия»: экспорт/импорт постфиксов в JSON; опциональная парольная защита (Argon2id + ChaCha20‑Poly1305).
 - «Буфер обмена»: настройте авто‑очистку (секунды, 0 = выкл.). После копирования буфер очищается по таймеру.
 - «Показ по удержанию»: зажмите кнопку «Показать» для краткого отображения сгенерированного пароля; отпустите — пароль скрывается.

## Сборка (Desktop)
- Требуется: Node 18+, Rust stable, Tauri 2.
- Установка зависимостей: `npm install`
- Генерация иконок: `npm run tauri:icons` (из `src-tauri/icons/icon.svg`)
- Дев‑режим: `npm run tauri:dev`
- Релиз: `npm run tauri:build`

Примечания:
- macOS: нужен Xcode CLT; для распространения — codesign и нотарификация.
- Windows: Visual Studio Build Tools с компонентом C++.
- Linux: системные тулчейны и зависимости (GTK/WebKit по документации Tauri).

## Сборка (Mobile)
- iOS: Xcode + таргеты Rust; открыть проект после `tauri build`.
- Android: Android Studio; NDK и таргеты Rust (`aarch64-linux-android`).

Мобильные шаги будут уточняться (флаги безопасности, подпись и т.д.).

Иконки
- Отредактируйте `src-tauri/icons/icon.svg` и запустите `npm run tauri:icons`, чтобы сгенерировать наборы иконок в `src-tauri/icons/` для сборки.

## Чек‑лист перед релизом
- Запустите `npm run preflight` (проверка легаси‑выходов и наличия иконок).
- Проверьте поведение UI:
  - Viewer‑пароль запрашивается при каждой генерации; не хранится в памяти.
  - Быстрая генерация и сохранённые записи дают стабильные результаты между сессиями.
  - Авто‑очистка буфера обмена работает с заданной задержкой.
  - Windows/macOS: включена защита контента; при захвате окно блокируется.
  - Android: скриншоты/запись заблокированы (FLAG_SECURE).
  - iOS: при захвате показывается оверлей, чувствительные действия отключены.
- Сборки:
  - Desktop: `npm run tauri:build`
  - Android: `npm run mobile:android`
  - iOS: `npm run mobile:ios`
- Подпись/ноторификация: см. `RELEASE.md`.

## Разработка/Тест
- Мок UI‑панели: запустите `npm run dev`, откройте `http://localhost:5173/?test=1` и в DevTools выполните `window.SAFORIA_MOCK = true`. Тест‑панель сгенерирует v1/v2 без Rust‑бэкенда.

## Безопасность
- Viewer‑пароль нигде не сохраняется и каждый раз запрашивается при генерации.
- KDF: Argon2id (параметры для desktop/mobile) + ChaCha20‑Poly1305.
- Буфер обмена — только по действию пользователя; содержимое очищается в UI через ~30 секунд.
- Защита от снятия экрана: best‑effort (Windows SetWindowDisplayAffinity, macOS NSWindow sharingType). Для Android/iOS будет добавлено (FLAG_SECURE / отслеживание захвата).
  - iOS: нативное отслеживание захвата посылает событие `screen_capture_changed`; чувствительные действия блокируются и показывается оверлей.
  - Linux/Wayland: глобальный запрет захвата не гарантируется; включите «Скрывать чувствительные данные» (по умолчанию на Wayland).

## Алгоритмы
- Legacy v1: Base64(MD5(master||postfix)) без `=`.
- Legacy v2: Base64(SHA256(master||postfix)) с заменами `=`→`.`, `+`→`-`, `/`→`_`.
- Новые (len10/20/36, alnum/strong): итеративный SHA‑256 от `master||"::"||postfix||"::"||method_id`; символы выбираются без смещения через rejection sampling.

Проверка совместимости (legacy): используйте `references/password-store/manager.py` с командами `readv1` и `read`.
Быстрая проверка (Node): `npm run check:legacy` выводит v1/v2 для примеров. Свои значения: `npm run check:legacy -- <master> <postfix>`.

## Структура
- `src/` — UI (React + Vite).
- `src-tauri/` — Rust‑бэкенд (Tauri 2), криптография/генерация/хранилище.
- `references/` — исторические скрипты для совместимости.

## Где хранятся данные
- Каталог приложения по стандартам ОС (macOS `~/Library/Application Support/Saforia`, Windows `%APPDATA%/Saforia`, Linux `~/.local/share/Saforia`).
- Файлы: `master.enc`, `postfixes.json`, `config.json`.
- Диагностика: команда `storage_paths` (Tauri invoke) вернёт путь к каталогу и файлу мастера.

## План
- Реализовать мобильную защиту экрана и интеграцию буфера обмена.
- Импорт/экспорт списка постфиксов (опц. шифрованный архив).
- Показ «отпечатка» мастера в UI.
- Ужесточение настроек релиза (отключение devtools, CSP и т.п.).

Этот README будет пополняться по мере коммитов.
## Подпись и нотарификация (кратко)
- macOS: подпись сертификатом Developer ID Application и нотарификация через `notarytool`. Идентификатор в связке ключей или переменные окружения.
- Windows: подпись MSI/EXE утилитой `signtool.exe` (желательно EV‑сертификат). Указывайте сервер меток времени `/tr`.
- Android: настройте keystore и подпись Gradle (Tauri mobile).
- iOS: настройте подпись и provisioning profile в Xcode; bundle identifier должен совпадать.
## Профили (несколько мастеров)
- Можно хранить несколько мастер‑паролей (каждый зашифрован собственным viewer‑паролем). Каждый мастер имеет отпечаток (fingerprint).
- Переключатель профиля (справа вверху):
  - Показывает активный отпечаток, позволяет переключить («Use»), добавить новый мастер («Add Master…») или удалить («Del»).
  - Сохранённые записи привязаны к активному мастеру (старые записи без привязки показываются в любом профиле для совместимости).

## CSV‑резервная копия и импорт
- Экспорт CSV: по строке на запись — «fingerprint,label,postfix,method_id,created_at,id».
- Предпросмотр импорта: список отпечатков и число записей для каждого; перетяните локальный отпечаток на импортируемый, чтобы сопоставить, или бросьте на «Ignore», чтобы пропустить.
- Применение: записей с «Ignore» не будет в импорте; остальные импортируются под выбранные локальные отпечатки (Overwrite заменяет, иначе слияние).

Пример CSV (заголовок + одна запись):
```
fingerprint,label,postfix,method_id,created_at,id
9f86d081884c7d659a2feaa0c55ad015,Example,example.com,len36_strong,1730900000,1730900000-abcdef01
```
