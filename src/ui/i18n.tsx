import React from 'react'
import { invoke } from '../bridge'

export type Lang = 'en' | 'ru' | 'zh'

type Dict = Record<string, string>
type Bundle = Record<Lang, Dict>

const bundle: Bundle = {
  en: {
    howItWorks: 'How it works',
    settings: 'Settings…',
    settingsTitle: 'Settings',
    tabPreferences: 'Preferences',
    tabBackup: 'Backup',
    tabAbout: 'About',
    close: 'Close',
    language: 'Language',
    addMaster: 'Add Master…',
    bindLegacy: 'Bind legacy entries to active',
    noneSaved: 'None saved',
    masters: 'Masters',
    use: 'Use',
    del: 'Del',
    active: 'Active',
    search: 'Search…',
    label: 'Label',
    method: 'Method',
    postfix: 'Postfix',
    actions: 'Actions',
    save: 'Save',
    generate: 'Generate',
    deleteEntry: 'Delete',
    initialSetup: 'Initial setup',
    masterPassword: 'Master password',
    confirmMaster: 'Confirm master password',
    viewerPassword: 'Viewer password',
    confirmViewer: 'Confirm viewer password',
    saveMaster: 'Save master',
    defaultMethod: 'Default method',
    maskSensitive: 'Mask sensitive content (Linux/Wayland)',
    autosaveQuick: 'Autosave in Quick generate',
    autoClearClipboard: 'Auto-clear clipboard (seconds, 0 = off)',
    helpDefault: 'Affects Quick generate and defaults for newly added entries.',
    helpMask: 'On Wayland, global capture blocking is not guaranteed — masking keeps secrets hidden.',
    helpAutosave: 'When enabled, the “Save this postfix” option is checked by default in Quick generate.',
    helpAutoClear: 'Clears system clipboard contents after a delay; set to 0 to disable.',
    blockWhileCaptured: 'Block actions while screen capture is detected',
    helpBlockWhileCaptured: 'When enabled, generate/copy are disabled if the system reports active recording/mirroring.',
    showPostfixInList: 'Show postfix column in list (not recommended)',
    helpShowPostfixInList: 'Postfix is sensitive input and typically should not be shown.',
    viewerPromptTimeoutSeconds: 'Viewer prompt timeout (seconds)',
    helpViewerPrompt: 'Closes the viewer prompt after inactivity to avoid shoulder-surfing.',
    outputClearSecondsLabel: 'Auto-clear on-screen output (seconds, 0 = off)',
    helpOutputClear: 'Hides generated password on screen after a delay; clipboard clearing is configured separately.',
    copyOnConsoleGenerate: 'Copy to clipboard after console generate',
    helpCopyOnConsole: 'If enabled, copies generated password immediately when using the console.',
    holdOnlyReveal: 'Only hold-to-reveal (hide toggle button)',
    helpHoldOnlyReveal: 'Removes the toggle Reveal/Hide button; secrets are visible only while holding.',
    clearClipboardOnBlur: 'Clear clipboard on app blur/hidden',
    helpClearOnBlur: 'Clears clipboard and hides output when the app loses focus or becomes hidden.',
    autoCloseIn: 'Auto-close in',
    // toasts & dialogs
    toastMasterSaved: 'Master password saved (encrypted by viewer password).',
    toastCopied: 'Copied to clipboard',
    toastCopyFailed: 'Copy failed. Please copy manually.',
    toastEntryDeleted: 'Entry deleted',
    toastEntryDeleteFailed: 'Failed to delete entry',
    toastGenerateFailed: 'Failed to generate',
    toastBoundEntriesPrefix: 'Bound ',
    toastBoundEntriesSuffix: ' entries',
    toastActiveChanged: 'Active master changed',
    toastMasterDeleted: 'Master deleted',
    toastMasterDeleteFailed: 'Delete failed',
    confirmDeleteMaster: 'Delete this master?',
    copy: 'Copy',
    save: 'Save',
    masterMismatch: 'Master passwords do not match',
    viewerMismatch: 'Viewer passwords do not match',
    errEnterBoth: 'Enter both master and viewer passwords',
    toastSaveMasterFailedPrefix: 'Failed to save master: ',
    toastWrongViewer: 'Wrong viewer password',
    // backup
    exportToPath: 'Export to path',
    passphraseOptional: 'Passphrase (optional)',
    export: 'Export',
    exportedSuccessfully: 'Exported successfully',
    exportFailedPrefix: 'Export failed: ',
    exportHelp: 'Exports saved postfixes as JSON or an encrypted archive if passphrase is provided. Keep passphrases safe.',
    importFromPath: 'Import from path',
    passphraseIfUsed: 'Passphrase (if used)',
    overwrite: 'Overwrite',
    yes: 'Yes',
    no: 'No',
    import: 'Import',
    importedCountPrefix: 'Imported ',
    importedCountSuffix: ' entries',
    importFailedPrefix: 'Import failed: ',
    importHelp: 'Import merges with existing entries by default; choose Overwrite to replace all.',
    csvBackupTitle: 'CSV Backup',
    exportCsvToPath: 'Export CSV to path',
    exportCsv: 'Export CSV',
    exportedCsv: 'Exported CSV',
    exportCsvFailedPrefix: 'Export CSV failed: ',
    csvImportPath: 'Import CSV from path',
    previewCsvImport: 'Preview CSV import',
    csvMapTitle: 'Map imported fingerprints',
    applyMapping: 'Apply mapping',
    dropLocalHere: 'Drop local here',
    dropHereToIgnore: 'Drop here to ignore',
    importedFingerprints: 'Imported fingerprints',
    localMastersDrag: 'Local masters (drag to map)',
    // overlay
    overlayTitleCapture: 'Screen capture detected',
    overlayTitleMasked: 'Sensitive content masked',
    overlayMsgCapture: 'For your security, sensitive content is hidden while recording or mirroring is active.',
    overlayMsgWaylandMask: 'On Linux/Wayland, capture blocking is not guaranteed. Mask mode is enabled.',
    overlayMsgMaskEnabled: 'Mask mode is enabled by preferences.',
    // reveal UI
    holdToReveal: 'Hold to reveal',
    releaseToHide: 'Release to hide',
    hide: 'Hide',
    reveal: 'Reveal',
    emptyListHelp: 'No saved postfixes yet. Use the console below to generate and save your first site, or import from Backup.',
    ignore: 'Ignore',
    failedPrefix: 'Failed: ',
    toastSanitizedInput: 'Removed invisible/unsupported characters from input.',
    warnInvisibleChars: 'Input contains invisible/unsupported characters.',
    exporting: 'Exporting…',
    importing: 'Importing…',
    loading: 'Loading…',
    applying: 'Applying…',
    postfixHiddenHint: 'Postfix is hidden by default for security. You can enable it in Settings → Preferences.',
  },
  ru: {
    howItWorks: 'Как это работает',
    settings: 'Настройки…',
    settingsTitle: 'Настройки',
    tabPreferences: 'Параметры',
    tabBackup: 'Резервное копирование',
    tabAbout: 'О программе',
    close: 'Закрыть',
    language: 'Язык',
    addMaster: 'Добавить мастер…',
    bindLegacy: 'Привязать старые записи к активному',
    noneSaved: 'Нет сохранённых',
    masters: 'Мастера',
    use: 'Выбрать',
    del: 'Удалить',
    active: 'Активный',
    search: 'Поиск…',
    label: 'Метка',
    method: 'Метод',
    postfix: 'Постфикс',
    actions: 'Действия',
    save: 'Сохранить',
    generate: 'Сгенерировать',
    deleteEntry: 'Удалить',
    initialSetup: 'Первичная настройка',
    masterPassword: 'Мастер‑пароль',
    confirmMaster: 'Повторите мастер‑пароль',
    viewerPassword: 'Viewer‑пароль',
    confirmViewer: 'Повторите viewer‑пароль',
    saveMaster: 'Сохранить мастер',
    defaultMethod: 'Метод по умолчанию',
    maskSensitive: 'Скрывать чувствительные данные (Linux/Wayland)',
    autosaveQuick: 'Автосохранение в консоли',
    autoClearClipboard: 'Авто‑очистка буфера (сек., 0 = выкл.)',
    helpDefault: 'Влияет на консоль и новые записи.',
    helpMask: 'На Wayland блокировка записи экрана не гарантирована — маскирование скрывает секреты.',
    helpAutosave: 'Если включено, флажок «Сохранить постфикс» включён по умолчанию.',
    helpAutoClear: 'Очищает буфер обмена через задержку; 0 — не очищать.',
    blockWhileCaptured: 'Блокировать действия при записи экрана',
    helpBlockWhileCaptured: 'Если включено, генерация/копирование отключены при активной записи/зеркалировании.',
    showPostfixInList: 'Показывать столбец постфикса (не рекомендуется)',
    helpShowPostfixInList: 'Постфикс — чувствительный ввод, обычно его лучше не показывать.',
    viewerPromptTimeoutSeconds: 'Таймаут окна viewer (секунды)',
    helpViewerPrompt: 'Автоматически закрывает окно ввода viewer при бездействии.',
    outputClearSecondsLabel: 'Авто‑скрытие вывода на экране (сек., 0 = выкл.)',
    helpOutputClear: 'Скрывает сгенерированный пароль на экране через заданное время; очистка буфера настраивается отдельно.',
    copyOnConsoleGenerate: 'Копировать в буфер после генерации в консоли',
    helpCopyOnConsole: 'Если включено, сразу копирует пароль при генерации в консоли.',
    holdOnlyReveal: 'Только удерживание для показа (без кнопки Показать/Скрыть)',
    helpHoldOnlyReveal: 'Убирает кнопку Показать/Скрыть; секрет виден лишь во время удерживания.',
    clearClipboardOnBlur: 'Очищать буфер при сворачивании/потере фокуса',
    helpClearOnBlur: 'Очищает буфер обмена и скрывает вывод при потере фокуса или скрытии окна.',
    autoCloseIn: 'Автозакрытие через',
    // toasts & dialogs
    toastMasterSaved: 'Мастер‑пароль сохранён (зашифрован viewer‑паролем).',
    toastCopied: 'Скопировано в буфер обмена',
    toastCopyFailed: 'Не удалось скопировать. Скопируйте вручную.',
    toastEntryDeleted: 'Запись удалена',
    toastEntryDeleteFailed: 'Не удалось удалить запись',
    toastGenerateFailed: 'Не удалось сгенерировать',
    toastBoundEntriesPrefix: 'Привязано записей: ',
    toastBoundEntriesSuffix: '',
    toastActiveChanged: 'Активный мастер изменён',
    toastMasterDeleted: 'Мастер удалён',
    toastMasterDeleteFailed: 'Не удалось удалить',
    confirmDeleteMaster: 'Удалить этот мастер?',
    copy: 'Копировать',
    save: 'Сохранить',
    masterMismatch: 'Мастер‑пароли не совпадают',
    viewerMismatch: 'Viewer‑пароли не совпадают',
    errEnterBoth: 'Введите мастер‑пароль и viewer‑пароль',
    toastSaveMasterFailedPrefix: 'Не удалось сохранить мастер: ',
    toastWrongViewer: 'Неверный viewer‑пароль',
    // backup
    exportToPath: 'Экспорт в файл',
    passphraseOptional: 'Пароль архива (необязательно)',
    export: 'Экспорт',
    exportedSuccessfully: 'Экспорт выполнен',
    exportFailedPrefix: 'Ошибка экспорта: ',
    exportHelp: 'Экспортирует сохранённые постфиксы как JSON или как зашифрованный архив при указании пароля. Храните пароль в безопасности.',
    importFromPath: 'Импорт из файла',
    passphraseIfUsed: 'Пароль архива (если использовался)',
    overwrite: 'Перезаписать',
    yes: 'Да',
    no: 'Нет',
    import: 'Импорт',
    importedCountPrefix: 'Импортировано записей: ',
    importedCountSuffix: '',
    importFailedPrefix: 'Ошибка импорта: ',
    importHelp: 'По умолчанию импорт дополняет текущие записи; включите Перезаписать для полной замены.',
    csvBackupTitle: 'CSV‑резервная копия',
    exportCsvToPath: 'Экспорт CSV в файл',
    exportCsv: 'Экспорт CSV',
    exportedCsv: 'CSV экспортирован',
    exportCsvFailedPrefix: 'Ошибка экспорта CSV: ',
    csvImportPath: 'Импорт CSV из файла',
    previewCsvImport: 'Предпросмотр импорта CSV',
    csvMapTitle: 'Сопоставление импортированных отпечатков',
    applyMapping: 'Применить соответствие',
    dropLocalHere: 'Перетащите локальный сюда',
    dropHereToIgnore: 'Перетащите сюда, чтобы игнорировать',
    importedFingerprints: 'Импортированные отпечатки',
    localMastersDrag: 'Локальные мастера (перетащите для соответствия)',
    // overlay
    overlayTitleCapture: 'Обнаружена запись экрана',
    overlayTitleMasked: 'Скрыт чувствительный контент',
    overlayMsgCapture: 'Для вашей безопасности секреты скрываются, пока активна запись или зеркалирование.',
    overlayMsgWaylandMask: 'В Linux/Wayland блокировка записи не гарантирована. Включён режим маскировки.',
    overlayMsgMaskEnabled: 'Режим маскировки включён в настройках.',
    // reveal UI
    holdToReveal: 'Удерживайте, чтобы показать',
    releaseToHide: 'Отпустите, чтобы скрыть',
    hide: 'Скрыть',
    reveal: 'Показать',
    emptyListHelp: 'Нет сохранённых постфиксов. Используйте консоль ниже, чтобы сгенерировать и сохранить первый сайт, или выполните импорт в Резервном копировании.',
    ignore: 'Игнорировать',
    failedPrefix: 'Ошибка: ',
    toastSanitizedInput: 'Удалены невидимые/недопустимые символы из ввода.',
    warnInvisibleChars: 'Обнаружены невидимые/недопустимые символы.',
    exporting: 'Экспорт…',
    importing: 'Импорт…',
    loading: 'Загрузка…',
    applying: 'Применение…',
    postfixHiddenHint: 'Постфикс скрыт по умолчанию в целях безопасности. Включить можно в Настройки → Параметры.',
  },
  zh: {
    howItWorks: '如何工作',
    settings: '设置…',
    settingsTitle: '设置',
    tabPreferences: '偏好设置',
    tabBackup: '备份',
    tabAbout: '关于',
    close: '关闭',
    language: '语言',
    addMaster: '添加主密码…',
    bindLegacy: '绑定旧条目到当前',
    noneSaved: '没有保存的项目',
    masters: '主密码',
    use: '使用',
    del: '删除',
    active: '当前',
    search: '搜索…',
    label: '标签',
    method: '方法',
    postfix: '后缀',
    actions: '操作',
    save: '保存',
    generate: '生成',
    deleteEntry: '删除',
    initialSetup: '首次设置',
    masterPassword: '主密码',
    confirmMaster: '确认主密码',
    viewerPassword: 'Viewer 密码',
    confirmViewer: '确认 Viewer 密码',
    saveMaster: '保存主密码',
    defaultMethod: '默认方法',
    maskSensitive: '隐藏敏感内容（Linux/Wayland）',
    autosaveQuick: '控制台自动保存',
    autoClearClipboard: '自动清除剪贴板（秒，0 关闭）',
    helpDefault: '影响控制台和新建条目。',
    helpMask: '在 Wayland 平台，录屏拦截不可靠，建议隐藏敏感内容。',
    helpAutosave: '若启用，则默认勾选“保存后缀”。',
    helpAutoClear: '一段时间后清空剪贴板；0 表示不清空。',
    blockWhileCaptured: '检测到录屏时阻止操作',
    helpBlockWhileCaptured: '启用后，在系统报告录制/镜像时禁用生成/复制。',
    showPostfixInList: '在列表中显示后缀（不建议）',
    helpShowPostfixInList: '后缀属于敏感输入，通常不应显示。',
    viewerPromptTimeoutSeconds: 'Viewer 提示超时（秒）',
    helpViewerPrompt: '在无操作时自动关闭 Viewer 提示以防旁窥。',
    outputClearSecondsLabel: '自动隐藏屏幕输出（秒，0 关闭）',
    helpOutputClear: '在一段时间后隐藏屏幕上的密码；剪贴板清除单独设置。',
    copyOnConsoleGenerate: '控制台生成后复制到剪贴板',
    helpCopyOnConsole: '启用后，在控制台生成时立即复制密码。',
    holdOnlyReveal: '仅按住显示（隐藏显示/隐藏按钮）',
    helpHoldOnlyReveal: '移除显示/隐藏按钮；仅按住时可见。',
    clearClipboardOnBlur: '应用失焦/隐藏时清空剪贴板',
    helpClearOnBlur: '当应用失去焦点或隐藏时清空剪贴板并隐藏输出。',
    autoCloseIn: '自动关闭于',
    // toasts & dialogs
    toastMasterSaved: '主密码已保存（由 Viewer 密码加密）。',
    toastCopied: '已复制到剪贴板',
    toastCopyFailed: '复制失败，请手动复制。',
    toastEntryDeleted: '条目已删除',
    toastEntryDeleteFailed: '删除条目失败',
    toastGenerateFailed: '生成失败',
    toastBoundEntriesPrefix: '已绑定 ',
    toastBoundEntriesSuffix: ' 条',
    toastActiveChanged: '已切换当前主密码',
    toastMasterDeleted: '主密码已删除',
    toastMasterDeleteFailed: '删除失败',
    confirmDeleteMaster: '删除此主密码？',
    copy: '复制',
    save: '保存',
    masterMismatch: '主密码不一致',
    viewerMismatch: 'Viewer 密码不一致',
    errEnterBoth: '请输入主密码和 Viewer 密码',
    toastSaveMasterFailedPrefix: '保存主密码失败：',
    toastWrongViewer: 'Viewer 密码错误',
    // backup
    exportToPath: '导出到路径',
    passphraseOptional: '归档口令（可选）',
    export: '导出',
    exportedSuccessfully: '导出成功',
    exportFailedPrefix: '导出失败：',
    exportHelp: '导出为 JSON；若提供口令则导出加密归档。请妥善保管口令。',
    importFromPath: '从路径导入',
    passphraseIfUsed: '归档口令（如使用）',
    overwrite: '覆盖',
    yes: '是',
    no: '否',
    import: '导入',
    importedCountPrefix: '已导入 ',
    importedCountSuffix: ' 条',
    importFailedPrefix: '导入失败：',
    importHelp: '默认合并导入；选择覆盖以替换全部。',
    csvBackupTitle: 'CSV 备份',
    exportCsvToPath: '导出 CSV 到路径',
    exportCsv: '导出 CSV',
    exportedCsv: 'CSV 已导出',
    exportCsvFailedPrefix: '导出 CSV 失败：',
    csvImportPath: '从路径导入 CSV',
    previewCsvImport: '预览 CSV 导入',
    csvMapTitle: '映射导入的指纹',
    applyMapping: '应用映射',
    dropLocalHere: '拖拽本地到此处',
    dropHereToIgnore: '拖拽到此处忽略',
    importedFingerprints: '导入的指纹',
    localMastersDrag: '本地主密码（拖拽以映射）',
    // overlay
    overlayTitleCapture: '检测到屏幕录制',
    overlayTitleMasked: '敏感内容已隐藏',
    overlayMsgCapture: '为安全起见，录制/镜像时隐藏敏感内容。',
    overlayMsgWaylandMask: 'Linux/Wayland 上录屏拦截不可靠，已启用隐藏模式。',
    overlayMsgMaskEnabled: '已在设置中启用隐藏模式。',
    // reveal UI
    holdToReveal: '按住显示',
    releaseToHide: '松开隐藏',
    hide: '隐藏',
    reveal: '显示',
    emptyListHelp: '尚无保存的后缀。使用下方控制台生成并保存，或在备份中导入。',
    ignore: '忽略',
    failedPrefix: '失败：',
    toastSanitizedInput: '已从输入中移除不可见/不支持字符。',
    warnInvisibleChars: '输入包含不可见/不支持字符。',
    exporting: '正在导出…',
    importing: '正在导入…',
    loading: '正在加载…',
    applying: '正在应用…',
    postfixHiddenHint: '出于安全，默认隐藏后缀。可在 设置 → 偏好 中开启。',
  }
}

type Ctx = { lang: Lang, t: (k: string) => string, setLang: (l: Lang) => void }
const I18nContext = React.createContext<Ctx>({ lang: 'en', t: (k) => k, setLang: () => {} })

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const nav = (typeof navigator !== 'undefined' && navigator.language || 'en').toLowerCase()
  const guess: Lang = nav.startsWith('ru') ? 'ru' : nav.startsWith('zh') ? 'zh' : 'en'
  const [lang, setLangState] = React.useState<Lang>(() => {
    try { return (localStorage.getItem('saforia_lang') as Lang) || guess } catch { return guess }
  })
  const setLang = React.useCallback((l: Lang) => {
    try { localStorage.setItem('saforia_lang', l) } catch {}
    setLangState(l)
  }, [])
  React.useEffect(() => {
    // Try to sync with persisted app prefs (mock or tauri backend)
    invoke<{ lang?: string }>('get_prefs').then(p => {
      const v = (p?.lang || '').toLowerCase()
      if (v === 'en' || v === 'ru' || v === 'zh') setLangState(v as Lang)
    }).catch(() => {})
  }, [])
  const t = React.useCallback((k: string) => bundle[lang][k] || bundle.en[k] || k, [lang])
  return <I18nContext.Provider value={{ lang, t, setLang }}>{children}</I18nContext.Provider>
}

export function useI18n() { return React.useContext(I18nContext) }
